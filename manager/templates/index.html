<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mihomo Web</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --bg-body: #121212; --bg-sidebar: #1e1e1e; --bg-card: #252525; --text-main: #e0e0e0; --border-color: #333; }
        [data-theme="light"] { --bg-body: #f4f6f9; --bg-sidebar: #fff; --bg-card: #fff; --text-main: #212529; --border-color: #e1e4e8; }
        body { background: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        .sidebar { background: var(--bg-sidebar); width: 260px; height: 100vh; position: fixed; border-right: 1px solid var(--border-color); z-index: 1000; transition: 0.3s; }
        .content-area { margin-left: 260px; padding: 25px; }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .content-area { margin-left: 0; padding-top: 80px; }
            .mobile-nav { display: flex !important; position: fixed; top: 0; left: 0; right: 0; height: 65px; background: var(--bg-sidebar); z-index: 999; border-bottom: 1px solid var(--border-color); align-items: center; padding: 0 20px; justify-content: space-between; }
        }
        
        .log-entry { display: flex; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }
        .log-time { color: #888; min-width: 140px; }
        .log-tag { padding: 2px 6px; border-radius: 4px; margin-right: 10px; font-weight: bold; }
        .tag-INFO { background: #198754; } .tag-WARN { background: #ffc107; color: #000; } .tag-ERROR { background: #dc3545; }
    </style>
</head>
<body data-theme="dark">

<div class="mobile-nav d-none">
    <div class="d-flex align-items-center"><img src="/static/logo.png" width="30" class="me-2"><b>Mihomo</b></div>
    <button class="btn text-main" onclick="toggleMenu()"><i class="bi bi-list fs-2"></i></button>
</div>

<div class="sidebar d-flex flex-column" id="sidebar">
    <div class="p-4 d-flex justify-content-between">
        <div class="d-flex align-items-center"><img src="/static/logo.png" width="35" class="me-2"><h4>Mihomo</h4></div>
        <button class="btn btn-sm text-muted" onclick="toggleTheme()"><i class="bi bi-sun-fill" id="t-icon"></i></button>
    </div>
    <div class="nav flex-column p-3">
        <button class="nav-link active p-3 mb-2" data-bs-toggle="pill" data-bs-target="#tab-dash"><i class="bi bi-speedometer2 me-2"></i>概览</button>
        <button class="nav-link p-3 mb-2" data-bs-toggle="pill" data-bs-target="#tab-tasks" onclick="loadSettings()"><i class="bi bi-link-45deg me-2"></i>订阅与任务</button>
        <button class="nav-link p-3 mb-2" data-bs-toggle="pill" data-bs-target="#tab-notify" onclick="loadSettings()"><i class="bi bi-bell me-2"></i>通知</button>
        <button class="nav-link p-3" data-bs-toggle="pill" data-bs-target="#tab-logs" onclick="loadLogs()"><i class="bi bi-terminal me-2"></i>日志</button>
    </div>
</div>

<div class="content-area">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-dash">
            <div class="card p-4 d-flex flex-row justify-content-between align-items-center">
                <div><h5>系统状态</h5><span id="st-text">检测中...</span></div>
                <div class="btn-group"><button class="btn btn-success" onclick="ctl('start')">启动</button><button class="btn btn-danger" onclick="ctl('stop')">停止</button></div>
            </div>
            <div class="mt-4"><button class="btn btn-primary w-100 p-3" onclick="window.open('http://'+location.hostname+':9090/ui')">打开 Dashboard</button></div>
        </div>
        
        <div class="tab-pane fade" id="tab-tasks">
            <div class="card p-4 mb-4">
                <h6>订阅管理</h6>
                <input type="text" id="sub_url" class="form-control my-3" placeholder="订阅链接">
                <button class="btn btn-primary" onclick="saveSub()">保存并立即更新</button>
            </div>
            <div class="card p-0">
                <div class="p-3 border-bottom d-flex justify-content-between"><b>配置编辑</b><button class="btn btn-sm btn-primary" onclick="saveCfg()">保存重启</button></div>
                <textarea id="cfg-edt" class="form-control border-0" style="height:500px; font-family:monospace; background:#1e1e1e; color:#fff;"></textarea>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-logs">
            <div class="d-flex justify-content-between mb-3"><h5>实时日志 (倒序)</h5><button class="btn btn-sm btn-secondary" onclick="loadLogs()">刷新</button></div>
            <div id="log-box" class="p-3" style="background:#000; border-radius:8px; height:600px; overflow-y:auto;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); }
    function toggleTheme() {
        const b = document.body;
        const isDark = b.getAttribute('data-theme') === 'dark';
        b.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('t-icon').className = isDark ? 'bi bi-moon-fill' : 'bi bi-sun-fill';
    }

    async function api(p, d) { return (await fetch('/api'+p, d?{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}:{})).json(); }
    
    function loadLogs() {
        api('/logs').then(res => {
            const lines = res.logs.split('\n').filter(l => l.trim()).reverse();
            document.getElementById('log-box').innerHTML = lines.map(l => {
                const m = l.match(/time="([^"]+)" level=([^ ]+) msg="([^"]+)"/);
                if (!m) return `<div class="log-entry">${l}</div>`;
                return `<div class="log-entry"><span class="log-tag tag-${m[2].toUpperCase()}">${m[2].toUpperCase()}</span><span class="log-time">${m[1].replace('T',' ')}</span><span>${m[3]}</span></div>`;
            }).join('');
        });
    }

    // 状态自动刷新
    setInterval(() => api('/status').then(r => document.getElementById('st-text').innerHTML = r.running ? '<b class="text-success">● 运行中</b>' : '<b class="text-danger">● 已停止</b>'), 3000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mihomo ç®¡ç†é¢æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        textarea { font-family: monospace; font-size: 0.9rem; }
        #status-indicator { width: 15px; height: 15px; display: inline-block; border-radius: 50%; }
        .running { background-color: #198754; }
        .stopped { background-color: #dc3545; }
    </style>
</head>
<body>
<div class="container">
    <nav class="navbar navbar-light bg-white rounded p-3 mb-4 shadow-sm">
        <span class="navbar-brand mb-0 h1">ğŸ› ï¸ Mihomo Manager</span>
        <span class="navbar-text">
            çŠ¶æ€: <span id="status-indicator" class="stopped"></span>
            <span id="status-text">æ£€æµ‹ä¸­...</span>
        </span>
    </nav>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">âš™ï¸ æœåŠ¡æ§åˆ¶</div>
                <div class="card-body d-grid gap-2">
                    <button class="btn btn-success" onclick="doAction('start')">å¯åŠ¨æœåŠ¡</button>
                    <button class="btn btn-danger" onclick="doAction('stop')">åœæ­¢æœåŠ¡</button>
                    <button class="btn btn-warning" onclick="doAction('restart')">é‡å¯æœåŠ¡</button>
                    <hr>
                    <button class="btn btn-outline-dark" onclick="window.open('http://'+window.location.hostname+':9090/ui', '_blank')">ğŸš€ æ‰“å¼€ Dashboard (Zashboard)</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">ğŸ“¦ ç»´æŠ¤å·¥å…·</div>
                <div class="card-body d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="doAction('update_geo')">æ›´æ–° Geo æ•°æ®åº“</button>
                    <button class="btn btn-outline-primary" onclick="doAction('update_kernel')">æ›´æ–° Mihomo å†…æ ¸</button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>ğŸ“ é…ç½®æ–‡ä»¶ (config.yaml)</span>
                    <button class="btn btn-primary btn-sm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜å¹¶é‡å¯</button>
                </div>
                <div class="card-body p-0">
                    <textarea id="config-editor" class="form-control border-0 h-100" style="min-height: 500px;"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function updateStatus() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                const el = document.getElementById('status-indicator');
                const txt = document.getElementById('status-text');
                if (data.running) {
                    el.className = 'running';
                    txt.textContent = 'è¿è¡Œä¸­';
                    txt.className = 'text-success fw-bold';
                } else {
                    el.className = 'stopped';
                    txt.textContent = 'å·²åœæ­¢';
                    txt.className = 'text-danger fw-bold';
                }
            });
    }

    function loadConfig() {
        fetch('/api/config')
            .then(r => r.json())
            .then(data => {
                document.getElementById('config-editor').value = data.content;
            });
    }

    function saveConfig() {
        const content = document.getElementById('config-editor').value;
        if(!confirm('ç¡®å®šè¦ä¿å­˜ä¿®æ”¹å¹¶é‡å¯æœåŠ¡å—ï¼Ÿ')) return;
        
        fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: content})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                alert('ä¿å­˜æˆåŠŸï¼Œæ­£åœ¨é‡å¯æœåŠ¡...');
                doAction('restart');
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + data.message);
            }
        });
    }

    function doAction(action) {
        fetch('/api/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: action})
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                // alert('æ“ä½œæˆåŠŸ: ' + data.message);
                updateStatus();
            } else {
                alert('æ“ä½œå¤±è´¥: ' + data.message);
            }
        });
    }

    // åˆå§‹åŒ–
    loadConfig();
    updateStatus();
    setInterval(updateStatus, 5000);
</script>
</body>
</html>
